# hadolint global ignore=DL3004,DL3003
### Taken from https://wiki.archlinux.org/title/Toolbox
# hadolint global ignore=DL3007
FROM docker.io/archlinux/archlinux:latest

ENV NAME=arch-toolbox VERSION=rolling

LABEL com.github.containers.toolbox="true" \
  name="$NAME" \
  version="$VERSION"

# Set locale
RUN echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen \
  && locale-gen \
  && echo "LANG=en_US.UTF-8" > /etc/locale.conf

RUN pacman -Syu --noconfirm \
  && pacman -S sudo --noconfirm \
  && pacman -Scc --noconfirm \
  && echo "%wheel ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/toolbox

CMD ["bash"]
###

# Install base packages
ENV EDITOR=nvim
RUN pacman -S --noconfirm \
  curl openssh git bash-completion zip unzip bc \
  base-devel git \
  aws-cli-v2 terraform \
  fzf ripgrep neovim wl-clipboard \
  rustup rust-analizer \
  python-pip python-virtualenv python-pipx \
  neofetch

# Install python tooling
ENV PIPX_HOME=/opt/pipx
ENV PIPX_BIN_DIR=/usr/local/bin
# hadolint ignore=DL3013
RUN pipx install pylsp-mypy --include-deps \
  && pipx install poetry --include-deps \
  && pipx install black --include-deps \
  && pipx install isort --include-deps \
  && pipx install pylint --include-deps

# Install hadolint
RUN sudo -u nobody git clone https://aur.archlinux.org/hadolint-bin.git /tmp/hadolint-bin \
  && (cd /tmp/hadolint-bin && sudo -u nobody makepkg) \
  && pacman -U --noconfirm /tmp/hadolint-bin/hadolint-bin-*.pkg.tar.zst

# Terraform utils
RUN sudo -u nobody git clone https://aur.archlinux.org/terraform-ls-bin.git /tmp/terraform-ls-bin \
  && (cd /tmp/terraform-ls-bin && sudo -u nobody makepkg) \
  && pacman -U --noconfirm /tmp/terraform-ls-bin/terraform-ls-bin-*.pkg.tar.zst

# Azure
RUN sudo -u nobody git clone https://aur.archlinux.org/azure-cli.git /tmp/azure-cli \
  && (cd /tmp/azure-cli && sudo -u nobody makepkg) \
  && pacman -U --noconfirm /tmp/azure-cli/azure-cli-*.pkg.tar.zst
